# CQRS

### CQRS
- 데이터 저장소에 대한 읽기 및 업데이트 작업을 구분하는 패턴인 명령과 쿼리의 역할 분리
- CQRS는 CQS 원칙을 확장하는 아키텍처 패턴이다. 
- 시스템의 읽기 및 쓰기 작업을 다르게 처리하고 별도의 구성 요소에서 처리해야 함을 나타낸다. 
- 명령(데이터를 수정하는 쓰기 작업) 및 쿼리(데이터를 검색하는 읽기 작업)를 처리하는 책임을 시스템의 개별 부분으로 분리한다. 
- 이를 통해 독립적으로 확장, 조정 및 최적화할 수 있는 최적화된 읽기 및 쓰기 모델이 가능하다. 
- 쓰기 모델은 쓰기에 최적화된 다른 데이터 모델과 저장 메커니즘을 사용할 수 있는 반면 읽기 모델은 효율적인 쿼리 및 보고를 위해 맞춤화할 수 있다.


#### 특징
- 읽기 및 쓰기 요구 사항이 크게 다른 복잡한 시스템이나 도메인에서 자주 사용된다. 
- 책임을 분리함으로써 CQRS는 향상된 성능, 확장성 및 유연성과 같은 이점을 제공할 뿐만 아니라 시스템의 각 부분에 대해 서로 다른 기술 및 패턴을 사용할 수 있도록 한다.
- CRUD에서 Command는 CUD를 나타내고, Query는 R을 나타낸다.

#### CQRS 예시
- 예시를 보면 다음과 같을 수 있다.
```java
class OrderCommandHandler {
  constructor() {
  }

  placeOrder(order) {
  }
}

class OrderQueryHandler {
  constructor() {
  }

  getOrderById(orderId) {
    return orderDetails;
  }

  getOrderHistory(customerId) {
    return orderHistory;
  }
}
```

- OrderCommandHandler 및 OrderQueryHandler 클래스는 CQRS 원칙을 보여준다. 
- OrderCommandHandler는 주문하기(placeOrder 메서드)와 같은 주문 처리와 관련된 명령 처리를 담당한다. 
-  OrderQueryHandler는 ID로 주문 세부 정보 가져오기(getOrderById 메서드) 및 고객의 주문 내역 가져오기(getOrderHistory 메서드)와 같은 주문 검색과 관련된 쿼리 처리를 담당한다. 
- 명령 및 쿼리 책임을 분리하면 쓰기 및 읽기 작업을 독립적으로 처리하고 최적화할 수 있다.


### CQS
- CQS는 메서드 또는 기능을 명령 또는 쿼리로 분류해야 하지만 둘 다로 분류해서는 안 된다는 소프트웨어 설계 원칙이다. 
- 명령은 개체 또는 시스템의 상태를 수정하지만 값을 반환하지 않는 작업인 반면 쿼리는 부작용 없이 정보를 검색하는 작업이다. 
- 명령과 쿼리를 분리하면 더 명확한 코드 의미 체계를 달성하고 문제를 더 명확하게 분리할 수 있다. 
- 이러한 분리는 코드 가독성, 유지 관리 및 테스트 가능성을 향상시킬 수 있다.


#### CQS 예시
- CQS 예시를 보자.
```java
class ShoppingCart {
  constructor() {
    this.items = [];
  }

  addItem(item) {
    this.items.push(item);
  }

  getItemCount() {
    return this.items.length;
  }
}
```
- ShoppingCart 클래스는 CQS 원칙을 보인다. 
- addItem 메서드는 항목 배열에 항목을 추가하여 ShoppingCart 개체의 상태를 수정하는 명령이다. 
- getItemCount 메서드는 항목 배열의 길이를 반환하여 장바구니에 있는 항목의 총 수를 검색하는 쿼리이다.

> CQS는 개별 메서드 내에서 명령과 쿼리를 분리하는 데 중점을 두는 반면, CQRS는 이러한 분리를 시스템 수준에서 읽기 및 쓰기 작업을 처리하는 여러 구성 요소로 확장한다.


### SSOT
- 소프트웨어 개발 및 데이터 관리에서 일반적으로 사용되는 원칙 또는 개념이다. 
- 시스템이나 조직 내에서 정보 또는 데이터의 신뢰할 수 있는 단일 소스가 있어야 함을 제안한다.
- SSOT는 특정 데이터 조각에 대한 중앙의 결정적인 소스가 있는지 확인하는 것이다. 
- 이는 해당 데이터의 다른 모든 인스턴스 또는 표현이 단일 소스를 참조하고 동기화해야 함을 의미한다. 
- 데이터에 대한 모든 업데이트 또는 수정은 SSOT에서 이루어져야 하며 다른 모든 구성 요소 또는 시스템은 이 중앙 소스의 데이터에 의존하고 액세스해야 한다.


#### 특징
1. 일관성
   - 신뢰할 수 있는 단일 소스를 사용하면 시스템 또는 조직의 모든 부분이 동일한 최신 데이터로 작업할 수 있다. 
   - 이렇게 하면 동일한 데이터의 여러 버전 또는 복사본을 보유함으로써 발생할 수 있는 데이터 불일치 또는 충돌이 제거된다.

2. 정확성
   - 신뢰할 수 있는 단일 소스를 사용하면 데이터 정확성과 무결성 가능성이 높아진다. 
   - 소스에서 데이터를 검증하고 확인할 수 있으므로 불일치 또는 오류의 위험이 줄어든다.

3. 효율성
   - 신뢰할 수 있는 단일 소스를 가짐으로써 데이터를 관리하고 업데이트하기가 더 쉬워진다. 
   - 중앙 소스에서 변경할 수 있으며 다른 모든 구성 요소 또는 시스템은 복잡한 데이터 동기화 프로세스 없이도 업데이트된 정보를 검색할 수 있다.

4. 간소화된 유지 관리
   - 데이터가 단일 소스에 중앙 집중화되면 백업, 데이터 거버넌스 및 보안과 같은 유지 관리 작업이 간소화된다. 
   - 데이터 품질 표준을 적용하고 보안 조치를 일관되게 적용하는 것이 더 쉬워진다.


- 신뢰할 수 있는 소스 역할을 하는 데이터베이스 또는 데이터 관리 시스템을 사용하여 구현되는 경우가 많다. 또한 API(애플리케이션 프로그래밍 인터페이스) 또는 다른 구성 요소나 시스템이 단일 소스에 액세스하고 동기화할 수 있도록 하는 데이터 통합 메커니즘을 통해 촉진될 수 있다.


> 데이터 일관성, 정확성 및 효율성을 목표로 한다.



### Materialized View
- 구체화된 뷰는 미리 정의된 쿼리의 결과를 물리적 테이블로 저장하는 데이터베이스 개체이다. 
- 본질적으로 쿼리 결과 집합의 지속적인 표현이다. 
- 쿼리 실행 시 가상이고 동적으로 계산되는 일반 뷰와 달리 구체화된 뷰는 미리 계산되어 물리적 데이터로 저장되는 것이 큰 특징이다.


#### 특징
- 구체화된 뷰를 만드는 목적은 복잡하거나 리소스를 많이 사용하는 동일한 쿼리를 반복적으로 계산할 필요성을 줄여 쿼리 성능을 향상시키는 것
- 쿼리가 실행될 때 데이터베이스 엔진은 기본 테이블에서 원래의 잠재적으로 비용이 많이 드는 쿼리 작업을 수행하는 대신 구체화된 뷰에서 미리 계산된 결과를 검색한다.
- 처음에 기본 테이블에 대해 연결된 쿼리를 실행하여 채워진다. 
- 데이터베이스 시스템에 따라 구체화된 뷰는 자동으로 업데이트되거나 정기적으로 또는 기본 데이터가 변경될 때 수동으로 새로 고쳐질 수 있다. 
- 새로 고침 프로세스는 구체화된 뷰를 업데이트하여 기본 테이블에 있는 데이터의 최신 상태를 반영한다.
- 구체화된 뷰는 쿼리 실행 시간과 리소스 소비를 크게 줄일 수 있으므로 집계, 조인 또는 복잡한 계산과 관련된 쿼리에 특히 유용하다. 그러나 구체화된 뷰는 스토리지 공간을 소비하고 기본 테이블을 직접 쿼리하는 것과 비교하여 데이터 신선도에 약간의 대기 시간이 발생할 수 있으므로 장단점을 고려하는 것이 중요하다.



> 요약하면 RDB의 구체화된 뷰는 물리적 테이블로 저장된 쿼리 결과 집합의 미리 계산된 영구 표현이며, 미리 계산된 결과에 더 빠르게 액세스할 수 있도록 하여 기본 테이블에서 비용이 많이 드는 계산의 필요성을 줄여 쿼리 성능을 향상시킨다.



### OLTP(Online Transaction Processing)
- 예를들어 온라인 서점을 운영하고 있다. 
- 이 웹사이트에서 고객은 도서를 찾아보고 검색하고 장바구니에 추가하고 구매할 수 있다. 
- 이 시나리오에서 주요 초점은 일상적인 비즈니스 운영과 관련된 수많은 소규모 개별 트랜잭션을 처리하는 것이다.


#### 특징
- 고객이 장바구니에 책을 추가하거나 구매를 완료할 때마다 OLTP 거래가 수반된다. 
- 이러한 트랜잭션에는 일반적으로 소량의 데이터를 실시간으로 삽입, 업데이트 또는 삭제하는 작업이 포함된다.
- OLTP 시스템의 주요 특징은 다음과 같다.

1. 트랜잭션 특성: OLTP 시스템은 데이터의 작은 부분에 영향을 미치는 개별 트랜잭션 또는 작업을 처리한다.

2. 동시성: OLTP 시스템은 충돌이나 데이터 불일치 없이 동시에 트랜잭션을 수행하는 여러 사용자를 지원해야 한다.

3. 빠른 응답 시간: 시스템은 사용자 상호 작용에 신속하게 응답하여 원활한 온라인 상호 작용을 보장해야 한다.

4. 정규화된 데이터 모델: OLTP 데이터베이스는 일반적으로 데이터 중복성을 최소화하고 데이터 무결성을 보장하는 정규화된 데이터 모델을 사용한다.

> 이 예에서 고객이 장바구니에 책을 추가하거나 주문하면 OLTP 시스템이 트랜잭션을 기록하고 재고 수준을 업데이트하며 고객 세부 정보를 실시간으로 관리한다.

### OLAP(Online Analytical Processing)
- 비즈니스 성과, 고객 행동 및 재고 관리에 대한 통찰력을 얻기 위해 판매 데이터를 분석하고 보고서를 생성해야 하는 서점의 필요성을 고려해 보자. 
- OLAP는 이러한 분석 처리를 위해 작동합니다.

#### 특징
- OLAP를 사용하면 대량의 데이터를 집계 및 분석하여 복잡한 쿼리 및 보고를 지원할 수 있다. 
- OLAP 시스템은 다차원 분석을 제공하는 데 중점을 두어 사용자가 다양한 관점에서 데이터를 드릴다운, 분할 및 분석할 수 있도록 한다. 

1. 분석 특성: OLAP 시스템은 집계, 기록 및 요약 데이터를 제공하여 복잡한 분석, 데이터 마이닝 및 의사 결정 지원을 용이하게 한다.

2. 읽기 전용 및 일괄 업데이트: OLAP 시스템은 일반적으로 읽기 전용 또는 대부분 읽기 기반으로 작동합니다. 실시간이 아닌 배치 프로세스에서 주기적으로 데이터를 업데이트한다.

3. 비정규화된 데이터 모델: OLAP 데이터베이스는 종종 비정규화된 또는 스타 스키마 데이터 모델을 사용하여 쿼리 성능을 최적화하고 효율적인 다차원 분석을 지원한다.



### Event Sourcing
- 이벤트 소싱은 시간 경과에 따라 응용 프로그램 상태에서 발생하는 모든 변경 사항 또는 이벤트의 순차적 로그 캡처 및 저장을 강조하는 소프트웨어 개발 패턴 또는 아키텍처 접근 방식이다. 
- 개체 또는 엔터티의 현재 상태만 저장하는 대신 Event Sourcing은 현재 상태로 이어진 이벤트의 기록 레코드를 유지 관리한다.
- 이벤트 소싱에서 이벤트는 시스템 내에서 발생한 불변의 사실 또는 사건을 나타낸다. 
- 이러한 이벤트는 이벤트 로그 또는 이벤트 저장소에 저장되며 애플리케이션 상태에 대한 단일 소스 역할을 한다. 
- 이벤트 로그는 시스템의 기본 데이터 저장소가 되며 로그의 이벤트를 재생하거나 적용하여 현재 상태를 파생할 수 있다.


#### 특징
1. Full Audit Trail: 
   - 이벤트 소싱은 시스템 내의 모든 변경 사항 및 작업에 대한 자세한 감사 로그를 제공. 
   - 이벤트를 저장하면 발생한 일에 대한 완전한 기록을 갖게 되어 시스템이 어떻게 현재 상태에 도달했는지 이해할 수 있다.

2. 상태 재구성
   - 이벤트 소싱을 사용하면 이벤트 로그에서 이벤트를 재생하여 언제든지 애플리케이션의 상태를 재구성할 수 있다. 
   - 이 기능은 디버깅, 기록 분석 또는 과거 시나리오 재현에 유용하다.

3. 확장성 및 유연성
   - 이벤트 소싱은 데이터 처리에서 데이터 저장소를 분리하여 확장성과 유연성을 허용한다. 
   - 이벤트는 여러 구성 요소 또는 서비스에 의해 비동기식으로 분산 및 처리될 수 있으므로 확장성과 병렬 처리 가능성이 활성화된다.

4. DDD(Domain-Driven Design) 조정
   - 이벤트는 비즈니스 도메인 활동을 반영하고 복잡한 동작 및 프로세스를 정확하게 모델링하는 데 사용할 수 있으므로 이벤트 소싱은 도메인 기반 설계 원칙과 잘 일치한다.

5. 시간 여행 및 이벤트 재생
   - 이벤트는 변경 불가능하고 순서대로 저장되므로 이벤트를 선택적으로 재생하거나 특정 이벤트 시퀀스를 기반으로 시나리오를 시뮬레이션하여 이벤트 재생 또는 "시간 여행"을 수행할 수 있다. 
   - 이는 다양한 시나리오를 테스트, 디버깅 또는 시뮬레이션하는 데 유용할 수 있다.


> - Event Sourcing은 철저한 감사 추적, 기록 분석 또는 복잡한 시간 동작 추적이 필요한 복잡한 비즈니스 도메인 또는 시스템에서 자주 사용된다. 그러나 이벤트 저장소, 이벤트 소싱 프레임워크 및 이벤트 처리 메커니즘을 신중하게 설계하고 고려해야 하므로 시스템이 복잡해진다.
> - 전반적으로 Event Sourcing은 시스템 설계에서 감사 가능성, 임시 쿼리, 확장성 및 유연성과 같은 이점을 제공하는 기본 정보 소스로 이벤트 캡처 및 저장을 강조하는 패턴이다.



## 학습 키워드
- CQS
- CQRS
- SSOT(Single Source Of Truth)
- Materialized View
- OLTP(Online Transaction Processing)
- OLAP(Online Analytical Processing)
- Event Sourcing